---
phase: 08-transpiler-tool
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/ShaderTranspiler/ShaderTranspiler.csproj
  - tools/ShaderTranspiler/Program.cs
  - pipeline-checker/src/shaders/generated/input-convert.wgsl
  - pipeline-checker/src/shaders/generated/color-grade.wgsl
  - pipeline-checker/src/shaders/generated/rrt.wgsl
  - pipeline-checker/src/shaders/generated/odt.wgsl
  - pipeline-checker/src/shaders/generated/output-encode.wgsl
  - pipeline-checker/src/shaders/generated/display-remap.wgsl
autonomous: true
requirements:
  - TOOL-01
  - TOOL-02
  - TOOL-03
  - TOOL-04
must_haves:
  truths:
    - "Running dotnet run in tools/ShaderTranspiler/ produces 6 WGSL files in pipeline-checker/src/shaders/generated/"
    - "The transpiler uses Stride shader compiler API (ShaderMixinParser or EffectCompiler) to compile SDSL to HLSL"
    - "The transpiler invokes DXC to convert HLSL to SPIR-V and Naga to convert SPIR-V to WGSL"
    - "Each generated WGSL file contains the correct stage-specific uniform struct, entry points, and functions"
  artifacts:
    - path: "tools/ShaderTranspiler/ShaderTranspiler.csproj"
      provides: ".NET 8 console app project with Stride NuGet or project references"
      contains: "OutputType>Exe"
    - path: "tools/ShaderTranspiler/Program.cs"
      provides: "Full SDSL->HLSL->SPIR-V->WGSL transpilation pipeline"
      min_lines: 100
    - path: "pipeline-checker/src/shaders/generated/input-convert.wgsl"
      provides: "Stage 4 Input Interpretation WGSL"
      contains: "inputSpace"
    - path: "pipeline-checker/src/shaders/generated/color-grade.wgsl"
      provides: "Stage 5 Color Grading WGSL"
      contains: "exposure"
    - path: "pipeline-checker/src/shaders/generated/rrt.wgsl"
      provides: "Stage 6 RRT WGSL"
      contains: "tonemapOp"
    - path: "pipeline-checker/src/shaders/generated/odt.wgsl"
      provides: "Stage 7 ODT WGSL"
      contains: "tonemapOp"
    - path: "pipeline-checker/src/shaders/generated/output-encode.wgsl"
      provides: "Stage 8 Output Encoding WGSL"
      contains: "outputSpace"
    - path: "pipeline-checker/src/shaders/generated/display-remap.wgsl"
      provides: "Stage 9 Display Remap WGSL"
      contains: "blackLevel"
  key_links:
    - from: "tools/ShaderTranspiler/Program.cs"
      to: "Stride shader compiler"
      via: "ShaderMixinParser.Parse() or EffectCompiler"
      pattern: "ShaderMixin|EffectCompiler|HlslWriter"
    - from: "tools/ShaderTranspiler/Program.cs"
      to: "dxc.exe"
      via: "Process.Start for HLSL to SPIR-V"
      pattern: "dxc.*-spirv"
    - from: "tools/ShaderTranspiler/Program.cs"
      to: "naga"
      via: "Process.Start for SPIR-V to WGSL"
      pattern: "naga.*\\.spv.*\\.wgsl"
---

<objective>
Create a .NET 8 console app that converts the 6 SDSL stage shaders to WGSL via the Stride compiler (SDSL to HLSL), DXC (HLSL to SPIR-V), and Naga (SPIR-V to WGSL), producing ready-to-use WGSL files for the pipeline checker.

Purpose: Automate SDSL-to-WGSL conversion so the pipeline checker's shaders are always mathematically identical to the Stride shaders -- single source of truth, no hand-porting.
Output: `tools/ShaderTranspiler/` console app + 6 generated WGSL files in `pipeline-checker/src/shaders/generated/`
</objective>

<execution_context>
@C:/Users/TF/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/TF/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sdsl-stage-shaders/07-01-SUMMARY.md

# Source SDSL shaders (6 per-stage shaders from Phase 7)
@shaders/InputConvert_TextureFX.sdsl
@shaders/ColorGradeStage_TextureFX.sdsl
@shaders/RRTStage_TextureFX.sdsl
@shaders/ODTStage_TextureFX.sdsl
@shaders/OutputEncode_TextureFX.sdsl
@shaders/DisplayRemap_TextureFX.sdsl

# Spec with detailed WGSL templates, uniform structs, DXC/Naga flags
@specs-pipeline-checker/sections/section-02-shader-transpiler.md

# Existing hand-ported WGSL (reference for expected output format)
@pipeline-checker/src/shaders/generated/input-convert.wgsl

# Stride shader compiler source (for API reference)
# ShaderMixinParser at: C:/dev/vvvv/stride/sources/engine/Stride.Shaders.Parser/ShaderMixinParser.cs
# HlslWriter at: C:/dev/vvvv/stride/sources/engine/Stride.Core.Shaders/Writer/Hlsl/HlslWriter.cs
# Stride source at: C:/dev/vvvv/stride/sources/engine/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .NET 8 transpiler console app with full SDSL-HLSL-SPIRV-WGSL pipeline</name>
  <files>
    tools/ShaderTranspiler/ShaderTranspiler.csproj
    tools/ShaderTranspiler/Program.cs
  </files>
  <action>
Create `tools/ShaderTranspiler/` with two files:

**ShaderTranspiler.csproj:**
- .NET 8 console app (`OutputType: Exe`, `TargetFramework: net8.0`)
- Reference Stride shader packages. Try NuGet first (`Stride.Core.Shaders`, `Stride.Shaders.Parser` version 4.2.*). If NuGet packages don't exist or don't work, use ProjectReference to the local Stride source at `C:/dev/vvvv/stride/sources/engine/`:
  - `Stride.Shaders.Parser/Stride.Shaders.Parser.csproj`
  - `Stride.Core.Shaders/Stride.Core.Shaders.csproj`
  - And any transitive dependencies they need (Stride.Core, etc.)

**Program.cs:**
A ~200 line console app that:

1. **Configuration**: Define the 6 shader targets:
   - `InputConvert_TextureFX` -> `input-convert.wgsl`
   - `ColorGradeStage_TextureFX` -> `color-grade.wgsl`
   - `RRTStage_TextureFX` -> `rrt.wgsl`
   - `ODTStage_TextureFX` -> `odt.wgsl`
   - `OutputEncode_TextureFX` -> `output-encode.wgsl`
   - `DisplayRemap_TextureFX` -> `display-remap.wgsl`

2. **Stage 1 - SDSL to HLSL** (Stride compiler):
   - Set up an `IVirtualFileProvider` that resolves:
     - Custom SDSL files from `../../shaders/` (relative to tool)
     - Stride built-in shaders (ColorUtility, ShaderBase, FilterBase, etc.) from the Stride shader library paths
   - For each shader, use `ShaderMixinParser` to parse the mixin chain into a flattened AST
   - Use `HlslWriter` to emit HLSL text from the AST
   - Save intermediate HLSL to a temp directory for debugging

   **If ShaderMixinParser proves too complex** (requires engine context, DatabaseFileProvider setup, etc.), fall back to the **compilation cache extraction** approach:
   - The user has Stride installed at `C:/dev/vvvv/stride`
   - Look for shader compilation log/cache at known paths: `%STRIDE_BIN_DIRECTORY%/log/shader_*.hlsl` or `%APPDATA%/Stride/`
   - Or use `EffectCompiler` from `Stride.Shaders.Compiler` which may have a simpler API
   - As a last resort, the tool can be a thin wrapper that just does steps 2+3 (DXC + Naga) if HLSL files are provided as input

3. **Stage 2 - HLSL to SPIR-V** (DXC):
   - DXC is available at `C:/VulkanSDK/1.4.309.0/Bin/dxc.exe`
   - For each HLSL file, invoke: `dxc.exe shader.hlsl -spirv -T ps_6_0 -E main -Fo shader.spv -fvk-use-dx-layout -HV 2021`
   - Capture stderr and throw on non-zero exit

4. **Stage 3 - SPIR-V to WGSL** (Naga):
   - Check if `naga` is in PATH; if not, check `cargo install` location or print instructions
   - For each SPIR-V file, invoke: `naga shader.spv shader.wgsl --validate`
   - Capture stderr and throw on non-zero exit

5. **Stage 4 - Post-process WGSL**:
   - Add header comment with source file and generation timestamp
   - Add per-stage uniform struct (use the structs from the spec: section-02-shader-transpiler.md Section 4)
   - Add texture/sampler bindings (`@group(0) @binding(0..2)`)
   - Wrap logic in fullscreen vertex + fragment entry points (use the template from the spec Section 3.2)
   - Strip any `[EnumType]` remnants
   - Replace `streams.TexCoord` with `in.uv`

6. **Output**: Write 6 WGSL files to `../../pipeline-checker/src/shaders/generated/` (relative to tool)

**Important considerations:**
- DXC path: Use environment variable or fallback to `C:/VulkanSDK/1.4.309.0/Bin/dxc.exe`
- Naga: May need `cargo install naga-cli` first. Print a clear error message if not found.
- Matrix transposition: The SDSL->HLSL step preserves row-major. DXC->Naga may or may not handle transposition. The post-processing step should verify/fix matrix layout if needed.
- Temp files: Use a `temp/` subdirectory within the tool for intermediate HLSL and SPIR-V files.
- Error handling: Each stage should have clear error messages identifying which shader and which stage failed.
  </action>
  <verify>
- `dotnet restore` in `tools/ShaderTranspiler/` succeeds
- `dotnet build` in `tools/ShaderTranspiler/` succeeds
- Program.cs contains all 4 stages: SDSL->HLSL, HLSL->SPIR-V, SPIR-V->WGSL, post-process
  </verify>
  <done>
Transpiler project builds and contains the complete 4-stage pipeline. The code references Stride's shader compiler API for SDSL->HLSL, invokes DXC for HLSL->SPIR-V, invokes Naga for SPIR-V->WGSL, and has post-processing for WGSL cleanup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run transpiler and validate 6 generated WGSL files</name>
  <files>
    pipeline-checker/src/shaders/generated/input-convert.wgsl
    pipeline-checker/src/shaders/generated/color-grade.wgsl
    pipeline-checker/src/shaders/generated/rrt.wgsl
    pipeline-checker/src/shaders/generated/odt.wgsl
    pipeline-checker/src/shaders/generated/output-encode.wgsl
    pipeline-checker/src/shaders/generated/display-remap.wgsl
  </files>
  <action>
1. **Install Naga** if not already available:
   - Check `naga --version`. If not found, run `cargo install naga-cli` (Rust must be installed).
   - If Rust/cargo not available, note this as a blocker and attempt the pipeline up through DXC only.

2. **Run the transpiler**:
   - `cd tools/ShaderTranspiler && dotnet run`
   - Capture all output. If any stage fails, diagnose and fix:
     - SDSL->HLSL failures: May need to adjust file provider setup, shader source paths, or fall back to alternative approach
     - DXC failures: Check HLSL syntax, entry point names, shader model
     - Naga failures: Check SPIR-V validity, try without `--validate` flag
     - Post-processing: Verify uniform struct matches spec

3. **Validate each WGSL file** exists and contains expected content:
   - `input-convert.wgsl`: Has `inputSpace: i32` in uniform struct, `ToLinearRec709` or equivalent function
   - `color-grade.wgsl`: Has `exposure: f32`, `lift: vec3<f32>`, grading functions
   - `rrt.wgsl`: Has `tonemapOp: i32`, tonemap operator functions
   - `odt.wgsl`: Has `tonemapOp: i32`, `outputSpace: i32`, ODT functions
   - `output-encode.wgsl`: Has `outputSpace: i32`, `paperWhite: f32`, encoding functions
   - `display-remap.wgsl`: Has `blackLevel: f32`, `whiteLevel: f32`, remap function

4. **Validate WGSL syntax** by running `naga --validate` on each output file (if Naga is available).

5. **If the transpiler approach hits blockers** (Stride compiler API too complex, missing dependencies):
   - Document the specific failure in the summary
   - The spec (Section 8) defines a fallback: extract HLSL from Stride's compilation cache or manually provide HLSL inputs
   - At minimum, the tool should work as a DXC+Naga wrapper that accepts HLSL input files
  </action>
  <verify>
- 6 WGSL files exist in `pipeline-checker/src/shaders/generated/`
- Each file contains a `struct Uniforms` with stage-appropriate fields
- Each file contains `@vertex fn vs` and `@fragment fn fs` entry points
- `naga --validate` passes on each file (if Naga available)
- `dotnet run` in `tools/ShaderTranspiler/` completes without errors
  </verify>
  <done>
Running `dotnet run` in `tools/ShaderTranspiler/` produces 6 valid WGSL files in `pipeline-checker/src/shaders/generated/`. Each file has the correct uniform struct, entry points, and stage-specific processing functions. The generated WGSL is syntactically valid.
  </done>
</task>

</tasks>

<verification>
Phase 8 success criteria from ROADMAP:
1. Running the transpiler console app at `tools/ShaderTranspiler/` produces 6 WGSL files in `pipeline-checker/src/shaders/generated/` -- verified by `dotnet run` + checking file existence
2. The transpiler uses Stride NuGet packages to compile SDSL to HLSL (not manual parser init) -- verified by checking Program.cs uses Stride API
3. The transpiler invokes DXC (HLSL to SPIR-V) and Naga (SPIR-V to WGSL) -- verified by checking Program.cs process invocations
4. Generated WGSL files are syntactically valid and contain expected entry points and bindings -- verified by `naga --validate` on each file
</verification>

<success_criteria>
- `dotnet run` in `tools/ShaderTranspiler/` exits 0 and produces 6 WGSL files
- Each generated WGSL file has: uniform struct, texture/sampler bindings, vertex/fragment entry points
- `naga --validate` passes on all 6 WGSL files
- No manual HLSL writing -- the tool uses Stride's compiler for SDSL->HLSL
</success_criteria>

<output>
After completion, create `.planning/phases/08-transpiler-tool/08-01-SUMMARY.md`
</output>
